<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.library.borrow.mapper.BorrowRecordMapper">

    <!-- 借阅记录结果映射 -->
    <resultMap id="BorrowRecordResponseMap" type="com.library.borrow.dto.BorrowRecordResponse">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="bookId" column="book_id"/>
        <result property="bookIsbn" column="book_isbn"/>
        <result property="bookTitle" column="book_title"/>
        <result property="quantity" column="quantity"/>
        <result property="borrowTime" column="borrow_time"/>
        <result property="dueTime" column="due_time"/>
        <result property="returnTime" column="return_time"/>
        <result property="status" column="status"/>
        <result property="renewCount" column="renew_count"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <!-- 分页查询借阅记录 -->
    <select id="selectBorrowPage" resultMap="BorrowRecordResponseMap">
        SELECT
            id,
            user_id,
            username,
            book_id,
            book_isbn,
            book_title,
            quantity,
            borrow_time,
            due_time,
            return_time,
            status,
            renew_count,
            remark,
            create_time
        FROM t_borrow_record
        <where>
            deleted = 0
            <if test="query.userId != null">
                AND user_id = #{query.userId}
            </if>
            <if test="query.bookId != null">
                AND book_id = #{query.bookId}
            </if>
            <if test="query.bookTitle != null and query.bookTitle != ''">
                AND book_title LIKE CONCAT('%', #{query.bookTitle}, '%')
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.borrowStartTime != null">
                AND borrow_time &gt;= #{query.borrowStartTime}
            </if>
            <if test="query.borrowEndTime != null">
                AND borrow_time &lt;= #{query.borrowEndTime}
            </if>
            <if test="query.overdueOnly != null and query.overdueOnly == true">
                AND ((status IN (0, 3) AND due_time &lt; NOW()) OR status = 2)
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

</mapper>